% \chapter{Important first chapter}
% \label{chap:refs}
% 
% First chapter usually builds the theoretical background necessary for readers to understand the rest of the thesis. You should summarize and reference a lot of existing literature and research.
% 
% You should use the standard \emph{citations}\todo{Use \textbackslash{}emph command like this, to highlight the first occurrence of an important word or term. Reader will notice it, and hopefully remember the importance.}.
% 
% \begin{description}
% \item[Obtaining bibTeX citation] Go to Google Scholar\footnote{\url{https://scholar.google.com}}\todo{This footnote is an acceptable way to `cite' webpages or URLs. Documents without proper titles, authors and publishers generally do not form citations. For this reason, avoid citations of wikipedia pages.}, find the relevant literature, click the tiny double-quote button below the link, and copy the bibTeX entry.
% \item[Saving the citation] Insert the bibTeX entry to the file \texttt{refs.bib}. On the first line of the entry you should see the short reference name --- from Scholar, it usually looks like \texttt{author2015title} --- you will use that to refer to the citation.
% \item[Using the citation] Use the \verb|\cite| command to typeset the citation number correctly in the text; a long citation description will be automaticaly added to the bibliography at the end of the thesis. Always use a non-breakable space before the citing parenthesis to avoid unacceptable line breaks:
% \begin{Verbatim}
% Trees utilize gravity to invade ye
% noble sires~\cite{newton1666apple}.
% \end{Verbatim}
% \item[Why should I bother with citations at all?] For two main reasons:
% \begin{itemize}
% \item You do not have to explain everything in the thesis; instead you send the reader to refer to details in some other literature. Use citations to simplify the detailed explanations.
% \item If you describe something that already exists without using a citation, the reviewer may think that you \emph{claim} to have invented it. Expectably, he will demand academic correctness, and, from your perspective, being accused of plagiarism is not a good starting point for a successful defense. Use citations to identify the people who invented the ideas that you build upon.
% \end{itemize}
% \item[How many citations should I use?]
% Cite any non-trivial building block or assumption that you use, if it is published in the literature. You do not have to cite trivia, such as the basic definitions taught in the introductory courses.
% 
% The rule of thumb is that you should read, understand and briefly review at least around 4 scientific papers. A thesis that contains less than 3 sound citations will spark doubt in reviewers.
% \end{description}
% 
% There are several main commands for inserting citations, used as follows:
% \begin{itemize}
% \item \citet{knuth1979tex} described a great system for typesetting theses.
% \item We are typesetting this thesis with \LaTeX, which is based on \TeX{} and METAFONT~\cite{knuth1979tex}.
% \item \TeX{} was expanded to \LaTeX{} by \citet{lamport1994latex}, hence the name.
% \item Revered are the authors of these systems!~\cite{knuth1979tex,lamport1994latex}
% \end{itemize}
% 
% \section{Some extra assorted hints before you start writing English}
% 
% Strictly adhere to the English word order rules. The sentences follow a fixed structure with subject followed by a verb and an object (in this order). Exceptions to this rule must be handled specially, and usually separated by commas.
% 
% Mind the rules for placing commas:
% \begin{itemize}
% \item Use the \emph{Oxford comma} before `and' and `or' at the end of a longer, comma-separated list of items. Certainly use it to disambiguate any possible mixtures of conjunctions: \textit{`The car is available in red, red and green, and green versions.'}
% \item Do not use the comma before subordinate clauses that begin with `that' (like this one). English does not use subordinate clauses as often as Slavic languages because the lack of a suitable word inflection method makes them hard to understand. In scientific English, try to avoid them as much as possible. Ask doubtfully whether each `which' and `when' is necessary --- most of these helper conjunctions can be removed by converting the clause to non-subordinate.
% 
% As an usual example, \xxx{\textit{`The sentence, which I wrote, seemed ugly.'}} is perfectly bad; slightly improved by \xxx{\textit{`The sentence that I wrote seemed ugly.'}}, which can be easily reduced to \textit{`The sentence I wrote seemed ugly.'}. A final version with added storytelling value could say \textit{`I wrote a sentence but it seemed ugly.'}
% \item Consider placing extra commas around any parts of the sentence that break the usual word order, especially if they are longer than a single word.
% \end{itemize}
% 
% Do not write long sentences. One sentence should contain exactly one fact. Multiple facts should be grouped in a paragraph to communicate one coherent idea. Paragraphs are grouped in labeled sections for a sole purpose of making the navigation in the thesis easier. Do not use the headings as `names for paragraphs' --- the text should make perfect sense even if all headings are removed. If a section of your text contains one paragraph per heading, you might have wanted to write an explicit list instead.
% 
% Every noun needs a determiner (`a', `the', `my', `some', \dots); the exceptions to this rule, such as non-adjectivized names and indeterminate plural, are relatively scarce. Without a determiner, a noun can be easily mistaken for something completely different, such as an adjective or a verb.
% 
% Consult the books by \citet{glasman2010science} and \citet{sparling1989english} for more useful details.

\chapter{Theory}

% - LIDAR vs Photogrametrie

\section{Photogrammetry}
Since the Metashape software used by this paper to generate the models is closed-source, there is no easy way to describe the exact algorithms used. However, a forum statement from the lead developer Dmitry Semyonov \parencite{metashapeForumPost} outlined the general methods used, which this section aims to cover.

A common approach to generating models using photogrammetry can be summarized as follows:

TODO: markers?
\begin{enumerate}
	\item \textbf{feature extraction:} find features (points) that are stable under image transformations, 3D viewpoint change and illumination
	\item \textbf{feature matching:} match features across multiple pictures
	\item \textbf{bundle adjustment:} given the matched features, find the approximate camera locations in space
	\item \textbf{surface reconstruction:} construct the surface of the model
	\item \textbf{texturing:} apply texture on the constructed model
\end{enumerate}

The following sections will explore each of these in part.

\subsection{Feature extraction}
The image features are extracted using the Scale Invariant Feature Transform (SIFT) method described in \citet{lowe1999object}. Each of the features is a vector, invariant or partially invariant to linear and affine transformations, illuminance change and 3D transformations.



\subsection{Feature matching}
% Feature matching across the photos.
% At the first stage PhotoScan detects points in the source photos which are stable under viewpoint and lighting variations and generates a descriptor for each point based on its local neighborhood. These descriptors are used later to detect correspondences across the photos. This is similar to the well known SIFT approach, but uses different algorithms for a little bit higher alignment quality.
% - TODO: přečíst stažený papír

% from bundler:
% Create a list of images using the script 'extract_focal.pl' (this extracts focal length information, when available, from each image, and stores it in an image list).
% Generate (SIFT) features for each image.
% Match features between each pairs of images (this step can take a while). The computed feature matches are stored in a file called 'matches.init.txt'.
% Run 'bundler' with a suitable options file.

\subsection{Bundle adjustment}
% Solving for camera intrinsic and extrinsic orientation parameters.
% PhotoScan uses a greedy algorithm to find approximate camera locations and refines them later using a bundle-adjustment algorithm. This should have many things in common with Bundler, although we didn't compare our algorithm with Bundler thoroughly.
% - https://en.wikipedia.org/wiki/Bundle_adjustment
% - TODO: přečíst stažený papír

\subsection{Surface reconstruction}
% Dense surface reconstruction.
% At this step several processing algorithms are available. Exact, Smooth and Height-field methods are based on pair-wise depth map computation, while Fast method utilizes a multi-view approach.
% - TODO: ?

\subsection{Texturing}
% Texture mapping.
% At this stage PhotoScan parametrizes a surface possibly cutting it in smaller pieces, and then blends source photos to form a texture atlas.
% - TODO: ?
%

\subsection{Scaling and transformations using markers}
In certain cases (such as this one), it is necessary for the generated model to be correctly scaled and transformed, such that it corresponds to its size in the real world.

A common approach is using circular targets, which are placed around the scanned object.
Since the distance between them is known, it can be used to infer the correct scale of the entire model.

The type of the circular targets used is based on \citet{schneider19913,borisPatent} and is the only format supported by Metashape.
Each of the targets can encode a variable number of bits, depending on its size, from $12$ to $18$.
The bits are encoded in binary, with $0$ corresponding to white segments and $1$ to black ones.
For robustness, the following constraints are additionally imposed on each of the targets:

\begin{itemize}
\item the first bit is a parity bit ($0$ for odd, $1$ for even)
\item there must exist an opposing pair of $1$ bits
\item the targets must be rotationally invariant
\end{itemize}

\begin{figure}
\centering
	\includesvg[width=0.7\columnwidth]{images/targets.svg}
	\caption{18th 14-bit marker (left) and the corresponding binary value (right). The grey segments denote the opposing pair of $1$ bits and the blue circle denotes the parity bit. }
\end{figure}

\begin{table}
\centering\footnotesize\sf
\begin{tabular}{rrr}
\toprule
Bits & All targets & Valid targets \\
\midrule
12 & 4096   & 147 \\
14 & 16384  & 516 \\
16 & 65536  & 1861 \\
18 & 262144 & 6766 \\
\bottomrule
\end{tabular}
\caption{The number of targets, depending on the desired number of bits. TODO: cite the guy who wrote the algorithm}
\label{tab:markers}
\end{table}

This does reduce the number of viable targets (see \cref{tab:markers}) but is still more than enough for the purposes of scanning small objects.

\section{Picture pre-processing}
% - odstraňovaní pozadí - různé techniky
